<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ëê¨Âπ¥ÊõÜÊó•Ë®ò</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4a90e2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Fix for Electron: Hide module to force UMD to fallback to window -->
    <script>if (typeof module === 'object') { window.module = module; module = undefined; }</script>
    <!-- Load local script -->
    <script src="./lunar.js"></script>
    <!-- Restore module -->
    <script>if (window.module) module = window.module;</script>

    <style>
        :root {
            --primary-color: #4a90e2;
            --accent-color: #ff6b6b;
            --bg-color: #f0f2f5;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #333;
            --text-sub: #666;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --card-bg: rgba(30, 30, 30, 0.95);
                --text-main: #e0e0e0;
                --text-sub: #aaaaaa;
            }
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER DESIGN */
        header {
            background: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .nav-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--text-main);
            cursor: pointer;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Container for the 3 info blocks */
        .header-info {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        /* Individual blocks */
        .info-block {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Left: West/Minguo */
        .info-left {
            align-items: flex-end;
            text-align: right;
            font-size: 0.85rem;
            color: var(--text-main);
            font-weight: bold;
            min-width: 100px;
        }

        .info-left span {
            display: block;
        }

        .info-left .sub-text {
            font-size: 0.75rem;
            color: var(--text-sub);
            font-weight: normal;
        }

        /* Center: Month */
        .info-center {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--text-main);
            line-height: 1;
        }

        /* Right: Lunar Year/Month */
        .info-right {
            align-items: flex-start;
            text-align: left;
            font-size: 0.85rem;
            color: var(--text-main);
            font-weight: bold;
            min-width: 100px;
        }

        .info-right span {
            display: block;
        }

        .info-right .sub-text {
            font-size: 0.75rem;
            color: var(--text-sub);
            font-weight: normal;
        }

        /* Mobile Response: Stack or Shrink */
        @media (max-width: 500px) {
            .header-info {
                gap: 10px;
            }

            .info-left,
            .info-right {
                font-size: 0.75rem;
                min-width: auto;
            }

            .info-center {
                font-size: 1.8rem;
            }

            .nav-btn {
                font-size: 1.2rem;
                padding: 0 5px;
            }
        }

        /* CALENDAR BODY */
        .calendar-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            /* Force equal width */
            gap: 5px;
            /* Added to match days-grid */
            text-align: center;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-sub);
            font-size: 0.9rem;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            /* Force equal width */
            gap: 5px;
            padding-bottom: 80px;
        }

        .day-cell {
            background: var(--card-bg);
            border-radius: 8px;
            height: 85px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            /* Prevent expansion */
        }

        .day-cell.today {
            border: 2px solid var(--primary-color);
        }

        .day-cell.selected {
            background: var(--primary-color);
            color: white;
        }

        .day-cell.selected .lunar-date,
        .day-cell.selected .term-active {
            color: white !important;
        }

        .solar-date {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .lunar-date {
            font-size: 0.75rem;
            /* Slightly smaller */
            color: var(--text-sub);
            text-align: center;
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
            /* Add ... if too long */
            white-space: nowrap;
            /* Keep single line */
            width: 100%;
            top: 2px;
        }

        .term-active {
            color: var(--accent-color);
            font-weight: bold;
        }

        .has-diary-dot {
            width: 6px;
            height: 6px;
            background-color: var(--accent-color);
            border-radius: 50%;
            margin-top: auto;
            margin-bottom: 4px;
        }

        .weekend {
            color: var(--accent-color);
        }

        .other-month {
            opacity: 0.3;
        }

        /* MODAL & DIALOGS */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: flex-end;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        @media(min-width: 600px) {
            .modal {
                align-items: center;
            }

            .modal-content {
                border-radius: 16px;
                width: 500px;
                height: 600px;
                max-height: 90vh;
            }
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            height: 85vh;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding-bottom: 15px;
        }

        .modal-title h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .modal-subtitle {
            font-size: 0.9rem;
            color: var(--text-sub);
            margin-top: 4px;
        }

        textarea {
            width: 100%;
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            font-size: 1.1rem;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-main);
            resize: none;
            outline: none;
            margin-bottom: 15px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        button {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-close {
            background: #f1f2f6;
            color: #333;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 500;
        }

        .menu-popover {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 499;
        }

        .menu-popover.show {
            display: flex;
        }

        .menu-item {
            background: none;
            border: none;
            padding: 10px 15px;
            text-align: left;
            font-size: 1rem;
            color: var(--text-main);
            cursor: pointer;
        }

        .menu-item:hover {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        /* Reminder Alert */
        .reminder-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .reminder-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .reminder-box {
            background: white;
            width: 85%;
            max-width: 400px;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .reminder-overlay.active .reminder-box {
            transform: scale(1);
        }

        .reminder-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .reminder-text {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.5;
            text-align: left;
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        /* TODO LIST STYLES */
        .todo-list-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 10px;
            background: #fafafa;
        }

        .todo-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .todo-checkbox {
            margin-top: 6px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .todo-text {
            flex: 1;
            font-size: 1.1rem;
            line-height: 1.4;
            outline: none;
            min-height: 24px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .todo-del {
            background: none;
            border: none;
            color: #999;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 5px;
        }

        .todo-del:hover {
            color: #ff4757;
        }

        /* Dynamic Dots */
        .dots-container {
            display: flex;
            gap: 2px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: auto;
            margin-bottom: 4px;
            max-width: 100%;
            padding: 0 2px;
        }

        .dot {
            width: 6px;
            height: 6px;
            background-color: var(--accent-color);
            border-radius: 50%;
        }

        /* Remove old simple dot style */
        .has-diary-dot {
            display: none;
        }
    </style>
</head>

<body>

    <header>
        <button class="nav-btn" id="prevMonth">‚ùÆ</button>
        <div class="header-info">
            <!-- LEFT: Gregorian / Minguo -->
            <div class="info-block info-left" id="labelLeft">
                <span id="labelGregorian">2026Âπ¥</span>
                <span id="labelMinguo" class="sub-text">Ê∞ëÂúã 115 Âπ¥</span>
            </div>

            <!-- CENTER: Month -->
            <div class="info-block info-center" id="labelMonth">
                2Êúà
            </div>

            <!-- RIGHT: Lunar Year / Month -->
            <div class="info-block info-right" id="labelRight">
                <span id="labelLunarYear">‰∏ôÂçàÂπ¥</span>
                <span id="labelLunarMonth" class="sub-text">ËáòÊúà - Ê≠£Êúà</span>
            </div>
        </div>
        <button class="nav-btn" id="nextMonth">‚ùØ</button>
    </header>

    <div style="text-align: center; padding: 5px;">
        <button class="menu-item" onclick="goToToday()"
            style="background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); border-radius: 20px; padding: 5px 20px; display: inline-block;">ÂõûÂà∞‰ªäÂ§©</button>
    </div>

    <div class="calendar-container" id="swipeArea">
        <div class="weekdays">
            <div class="weekend">Êó•</div>
            <div>‰∏Ä</div>
            <div>‰∫å</div>
            <div>‰∏â</div>
            <div>Âõõ</div>
            <div>‰∫î</div>
            <div class="weekend">ÂÖ≠</div>
        </div>
        <div class="days-grid" id="daysGrid"></div>
    </div>

    <!-- FAB & Menu -->
    <div class="fab" onclick="toggleMenu()">+</div>
    <div class="menu-popover" id="menuPopover">
        <button class="menu-item" onclick="exportData()">üì§ ÂåØÂá∫ÂÇô‰ªΩ (JSON)</button>
        <button class="menu-item" onclick="document.getElementById('importFile').click()">üì• ÂåØÂÖ•Ë≥áÊñô</button>
        <input type="file" id="importFile" hidden accept=".json" onchange="importData(this)">
    </div>

    <!-- Editor Modal -->
    <div class="modal" id="diaryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <h2 id="modalDateStr">Êó•Êúü</h2>
                    <div class="modal-subtitle" id="modalLunarStr">Ëæ≤ÊõÜË≥áË®ä</div>
                </div>
                <button class="btn-close" onclick="closeModal()">‚úï</button>
            </div>
            <div id="todoList" class="todo-list-container">
                <!-- Items will be injected here -->
            </div>
            <div class="add-item-row" style="text-align: right;">
                <button class="btn-primary" onclick="addTodo()" style="padding: 8px 16px; font-size: 0.9rem;">+
                    Êñ∞Â¢ûË®ò‰∫ã</button>
            </div>
        </div>
    </div>

    <!-- Today's Reminder Alert -->
    <div class="reminder-overlay" id="reminderOverlay">
        <div class="reminder-box">
            <div class="reminder-title">üìÖ ‰ªäÊó•ÂæÖËæ¶‰∫ãÈ†Ö</div>
            <div class="reminder-text" id="reminderText"></div>
            <button class="btn-primary" style="width: 100%" onclick="closeReminder()">Êî∂Âà∞‰∫Ü</button>
        </div>
    </div>

    <script>
        // State
        let displayDate = new Date();
        let selectedDateISO = null; // YYYY-MM-DD

        // DOM Elements
        const elements = {
            daysGrid: document.getElementById('daysGrid'),
            labelGregorian: document.getElementById('labelGregorian'),
            labelMinguo: document.getElementById('labelMinguo'),
            labelMonth: document.getElementById('labelMonth'),
            labelLunarYear: document.getElementById('labelLunarYear'),
            labelLunarMonth: document.getElementById('labelLunarMonth'),

            diaryModal: document.getElementById('diaryModal'),
            // diaryInput: document.getElementById('diaryInput'), // Removed
            modalDateStr: document.getElementById('modalDateStr'),
            modalLunarStr: document.getElementById('modalLunarStr'),
            menuPopover: document.getElementById('menuPopover'),
            reminderOverlay: document.getElementById('reminderOverlay'),
            reminderText: document.getElementById('reminderText')
        };

        // Init
        window.onload = () => {
            renderCalendar();
            registerSW();
            checkTodayReminder();
        };

        function registerSW() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(() => console.log('Service Worker Registered'))
                    .catch(err => console.error('SW Registration Fail', err));
            }
        }

        // --- Logic ---

        // --- Helpers ---

        function toTraditional(str) {
            if (!str) return '';
            const map = {
                'ËÖä': 'Ëáò', 'Èó∞': 'Èñè', 'È©¨': 'È¶¨', 'È∏°': 'Èõû', 'Áå™': 'Ë±¨', 'Èæô': 'Èæç',
                'ËäÇ': 'ÁØÄ', 'Ê∞î': 'Ê∞£', 'Ë¥ù': 'Ë≤ù', 'È£é': 'È¢®', 'ÂõΩ': 'Âúã', 'Â∫Ü': 'ÊÖ∂',
                'Âä®': 'Âãï', 'Âä≥': 'Âãû', 'ÂºÄ': 'Èñã', 'ÂÖ≥': 'Èóú', 'Èó®': 'ÈñÄ', 'Êà∑': 'Êà∂',
                'Â¶á': 'Â©¶', '‰∫ß': 'Áî¢', '‰ºö': 'ÊúÉ', '‰∏á': 'Ëê¨', 'ÂéÜ': 'ÊõÜ', 'Èò≥': 'ÈôΩ',
                'Èò¥': 'Èô∞', 'Âèë': 'Áôº', 'Ë¥¢': 'Ë≤°', 'Á•û': 'Á•û', 'Âú£': 'ËÅñ', 'ËØû': 'Ë™ï',
                'Á∫™': 'Á¥Ä', 'Âøµ': 'Âøµ', 'Âíå': 'Âíå', 'Âπ≥': 'Âπ≥', 'Âè∞': 'Ëá∫', 'Êπæ': 'ÁÅ£',
                'ÂÆù': 'ÂØ∂', 'Â≤õ': 'Â≥∂'
            };
            return str.split('').map(c => map[c] || c).join('');
        }

        function getCustomFestival(sM, sD, lM, lD) {
            // Solar Holidays (Fixed)
            if (sM === 1 && sD === 1) return 'ÂÖÉÊó¶';
            if (sM === 2 && sD === 28) return 'ÂíåÂπ≥Á¥ÄÂøµÊó•';
            if (sM === 4 && sD === 4) return 'ÂÖíÁ´•ÁØÄ'; // 4/4 fixed for simplicity
            if (sM === 5 && sD === 1) return 'ÂãûÂãïÁØÄ';
            if (sM === 10 && sD === 10) return 'ÂúãÊÖ∂Êó•';
            if (sM === 12 && sD === 25) return 'ËÅñË™ïÁØÄ';

            // Lunar Holidays
            if (lM === 1 && lD === 1) return 'Êò•ÁØÄ';
            if (lM === 1 && lD === 15) return 'ÂÖÉÂÆµÁØÄ';
            if (lM === 5 && lD === 5) return 'Á´ØÂçàÁØÄ';
            if (lM === 7 && lD === 7) return '‰∏ÉÂ§ï';
            if (lM === 7 && lD === 15) return '‰∏≠ÂÖÉÁØÄ';
            if (lM === 8 && lD === 15) return '‰∏≠ÁßãÁØÄ';
            if (lM === 9 && lD === 9) return 'ÈáçÈôΩÁØÄ';
            if (lM === 12 && lD === 8) return 'ËáòÂÖ´';
            if (lM === 12 && lD === 24) return 'ÈÄÅÁ•û';
            // Èô§Â§ï (Simply checking 12/30 or 12/29 is complex without next day check, skipping for stability)

            return '';
        }

        function getLunarInfo(date) {
            if (typeof Lunar === 'undefined') return { text: '', full: '' };

            try {
                const d = Lunar.fromDate(date);

                // Native Lunar.js Outputs
                let dayText = toTraditional(d.getDayInChinese());
                let monthText = toTraditional(d.getMonthInChinese());
                let yearText = toTraditional(d.getYearInGanZhi());
                let zodiac = toTraditional(d.getYearShengXiao());
                let jieQi = toTraditional(d.getJieQi());

                // Custom Logic
                const sM = date.getMonth() + 1;
                const sD = date.getDate();
                const lM = d.getMonth();
                const lD = d.getDay();

                const customFest = getCustomFestival(sM, sD, lM, lD);

                let showText = dayText;
                let isTerm = false;

                if (customFest) {
                    showText = customFest;
                    isTerm = true; // Highlight
                } else if (jieQi) {
                    showText = jieQi;
                    isTerm = true;
                } else if (dayText === 'Âàù‰∏Ä') {
                    showText = monthText + 'Êúà';
                }

                // Append full string
                let fullStr = `${yearText}Âπ¥(${zodiac}) Ëæ≤ÊõÜ${monthText}Êúà${dayText}`;
                if (jieQi) fullStr += ` ‚Ä¢ ${jieQi}`;
                if (customFest) fullStr += ` ‚Ä¢ ${customFest}`;

                return {
                    text: showText,
                    full: fullStr,
                    isTerm: isTerm
                };
            } catch (e) {
                console.error('Lunar Error', e);
                return { text: '', full: '' };
            }
        }

        function renderCalendar() {
            const y = displayDate.getFullYear();
            const m = displayDate.getMonth();

            // --- Header Update ---
            elements.labelGregorian.innerText = `${y}Âπ¥`;
            elements.labelMinguo.innerText = `Ê∞ëÂúã ${y - 1911} Âπ¥`;
            elements.labelMonth.innerText = `${m + 1}Êúà`;

            try {
                const d1 = new Date(y, m, 1);
                const l1 = Lunar.fromDate(d1);
                const d2 = new Date(y, m + 1, 0);
                const l2 = Lunar.fromDate(d2);

                const startLunar = toTraditional(l1.getMonthInChinese());
                const endLunar = toTraditional(l2.getMonthInChinese());
                const yearGanZhi = toTraditional(l1.getYearInGanZhi()); // e.g. ‰∏ôÂçà
                const zodiac = toTraditional(l1.getYearShengXiao());    // e.g. È¶¨

                // Lunar Year Display
                elements.labelLunarYear.innerText = `${yearGanZhi}Âπ¥ / ${zodiac}`;

                // Lunar Month Display
                let lunarStr = `Ëæ≤ÊõÜ ${startLunar}Êúà`;
                if (startLunar !== endLunar) {
                    lunarStr += ` - ${endLunar}Êúà`;
                }
                elements.labelLunarMonth.innerText = lunarStr;

            } catch (e) {
                console.error(e);
                elements.labelLunarYear.innerText = '';
                elements.labelLunarMonth.innerText = '';
            }

            elements.daysGrid.innerHTML = '';

            // Grid
            const firstDay = new Date(y, m, 1);
            const lastDay = new Date(y, m + 1, 0);
            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();

            // Prev Month
            const prevMonthLastDay = new Date(y, m, 0).getDate();
            for (let i = 0; i < startDay; i++) {
                const d = prevMonthLastDay - (startDay - 1 - i);
                elements.daysGrid.appendChild(createCell(d, true));
            }

            // Current Month
            const today = new Date();
            for (let d = 1; d <= totalDays; d++) {
                const currentDayDate = new Date(y, m, d);
                const isToday = currentDayDate.toDateString() === today.toDateString();
                elements.daysGrid.appendChild(createCell(d, false, currentDayDate, isToday));
            }

            // Next Month
            const endDay = lastDay.getDay();
            if (endDay < 6) {
                for (let i = 1; i <= (6 - endDay); i++) {
                    elements.daysGrid.appendChild(createCell(i, true));
                }
            }
        }

        function createCell(dayNum, isOtherMonth, dateObj = null, isToday = false) {
            const div = document.createElement('div');
            div.className = `day-cell ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}`;

            let content = `<div class="solar-date">${dayNum}</div>`;

            if (!isOtherMonth && dateObj) {
                const iso = toISO(dateObj);
                const lunar = getLunarInfo(dateObj);

                // Get dots count
                const raw = localStorage.getItem('diary_' + iso);
                let items = [];
                if (raw) {
                    if (raw.startsWith('[')) {
                        try { items = JSON.parse(raw); } catch (e) { }
                    } else {
                        items = [{ done: false }]; // Old format count as 1
                    }
                }

                // Count ONLY UNFINISHED items for dots? Or all? 
                // User said: "Á¥ÖÈªûÊúÉÈö®ÊàëË®ò‰∫ãÂ§öÂØ°Âá∫ÁèæÁ¥ÖÈªû" (Red dots appear according to amount of notes). It implies count of notes.
                // Usually todo apps show dots for *unfinished* tasks or just existence.
                // Re-reading: "Â¶ÇÊûúÊàëÂè™Êúâ‰∏Ä‰ª∂‰∫ãÂ∞±‰∏ÄÂÄãÁ¥ÖÈªû-Êúâ‰∫î‰ª∂‰∫ãÂ∞±‰∫îÂÄãÁ¥ÖÈªû"
                // I will render dots for ALL items, but maybe diff color for done? 
                // Let's stick to simple: Dot = Item. 
                // Wait, if I finish a task, should the dot go away? "ÂÑ≤Â≠ò‰πãÂæå...ÊúâÁ¥ÖÈªû"
                // Let's assume Dot = Valid Task.

                content += `<div class="lunar-date ${lunar.isTerm ? 'term-active' : ''}">${lunar.text}</div>`;

                if (items.length > 0) {
                    content += `<div class="dots-container">`;
                    // Limit to e.g. 10 to avoid overflow
                    const count = Math.min(items.length, 12);
                    for (let i = 0; i < count; i++) {
                        // Check if done
                        const isDone = items[i].done;
                        // User didn't specify color for done, but usually done = less visible or green?
                        // User said: "Á¥ÖÈªû (Red Point)". 
                        // Implementation: Red dot for all, maybe opacity for done if needed, but current req is just "dots count".
                        // OPTIONAL IMPROVEMENT: Only show RED dots for unfinished, and maybe GREY for finished?
                        // Let's keep it simple as requested: Red dots = Item count. 
                        // Actually, standard UI: Dot usually means "Something here". 
                        // Let's make it: Unfinished = Red Item, Finished = Hollow or Grey? 
                        // "Êúâ‰∫î‰ª∂‰∫ãÂ∞±‰∫îÂÄãÁ¥ÖÈªû" -> 5 Red Dots. 

                        // Update: To help user distinguish, I will make done items slightly transparent or different style if I can, 
                        // but to strictly follow "Red Dot", I will use Red.
                        // However, for better UX: if done, maybe a green dot? 
                        // I'll stick to Red for now as requested.

                        content += `<div class="dot" style="${isDone ? 'opacity: 0.3; background-color: #aaa' : ''}"></div>`;
                    }
                    content += `</div>`;
                }

                const dayOfWeek = dateObj.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) div.classList.add('weekend');

                div.onclick = () => openEditor(dateObj, lunar.full);
            } else {
                content += `<div class="lunar-date">&nbsp;</div>`;
            }

            div.innerHTML = content;
            return div;
        }

        // --- Interactions ---

        function toISO(date) {
            const offset = date.getTimezoneOffset();
            date = new Date(date.getTime() - (offset * 60 * 1000));
            return date.toISOString().split('T')[0];
        }

        function openEditor(date, lunarFullText) {
            selectedDateISO = toISO(date);
            const y = date.getFullYear();
            const m = date.getMonth() + 1;
            const d = date.getDate();
            const weekMap = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];

            elements.modalDateStr.innerText = `${y}Âπ¥ ${m}Êúà ${d}Êó• (ÊòüÊúü${weekMap[date.getDay()]})`;
            elements.modalLunarStr.innerText = lunarFullText;

            // Load items
            renderTodoList();
            elements.diaryModal.classList.add('active');
        }

        // --- Todo List Logic ---

        function getTodoItems(isoDate) {
            const raw = localStorage.getItem('diary_' + isoDate);
            if (!raw) return [];

            // Migration: If string doesn't start with '[', treat as old plain text
            if (!raw.startsWith('[')) {
                return [{ id: Date.now(), text: raw, done: false }];
            }

            try {
                return JSON.parse(raw);
            } catch (e) {
                return [{ id: Date.now(), text: raw, done: false }];
            }
        }

        function saveTodoItems(isoDate, items) {
            if (!items || items.length === 0) {
                localStorage.removeItem('diary_' + isoDate);
            } else {
                localStorage.setItem('diary_' + isoDate, JSON.stringify(items));
            }
            renderCalendar(); // Refresh dots
        }

        function renderTodoList() {
            const listContainer = document.getElementById('todoList');
            if (!listContainer) {
                // Should not happen if HTML is correct, but safe check
                return;
            }
            listContainer.innerHTML = '';

            const items = getTodoItems(selectedDateISO);

            items.forEach(item => {
                const li = document.createElement('div');
                li.className = 'todo-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = item.done;
                checkbox.className = 'todo-checkbox';
                checkbox.onchange = () => toggleItem(item.id);

                const text = document.createElement('div');
                text.className = 'todo-text';
                text.contentEditable = true;
                text.innerText = item.text;
                text.onblur = (e) => updateItemText(item.id, e.target.innerText);

                const delBtn = document.createElement('button');
                delBtn.className = 'todo-del';
                delBtn.innerText = '‚úï';
                delBtn.onclick = () => deleteItem(item.id);

                li.appendChild(checkbox);
                li.appendChild(text);
                li.appendChild(delBtn);
                listContainer.appendChild(li);
            });
        }

        function addTodo() {
            if (!selectedDateISO) return;
            const items = getTodoItems(selectedDateISO);
            items.push({ id: Date.now(), text: '', done: false });
            saveTodoItems(selectedDateISO, items);
            renderTodoList();

            // Focus new item
            setTimeout(() => {
                const list = document.getElementById('todoList');
                const lastItem = list.lastElementChild;
                if (lastItem) {
                    const textBox = lastItem.querySelector('.todo-text');
                    textBox.focus();
                }
            }, 50);
        }

        function toggleItem(id) {
            if (!selectedDateISO) return;
            const items = getTodoItems(selectedDateISO);
            const target = items.find(i => i.id === id);
            if (target) {
                target.done = !target.done;
                saveTodoItems(selectedDateISO, items);
            }
        }

        function updateItemText(id, newText) {
            if (!selectedDateISO) return;
            const items = getTodoItems(selectedDateISO);
            const target = items.find(i => i.id === id);
            if (target) {
                target.text = newText;
                saveTodoItems(selectedDateISO, items);
            }
        }

        function deleteItem(id) {
            if (!selectedDateISO) return;
            // Confirmation logic added as requested
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãË®ò‰∫ãÂóéÔºü')) return;

            let items = getTodoItems(selectedDateISO);
            items = items.filter(i => i.id !== id);
            saveTodoItems(selectedDateISO, items);
            renderTodoList();
        }

        function closeModal() {
            elements.diaryModal.classList.remove('active');
            selectedDateISO = null;
        }

        function toggleMenu() {
            elements.menuPopover.classList.toggle('show');
        }

        document.getElementById('prevMonth').onclick = () => { displayDate.setMonth(displayDate.getMonth() - 1); renderCalendar(); };
        document.getElementById('nextMonth').onclick = () => { displayDate.setMonth(displayDate.getMonth() + 1); renderCalendar(); };
        function goToToday() { displayDate = new Date(); renderCalendar(); }

        // --- Reminders ---

        function checkTodayReminder() {
            const todayISO = toISO(new Date());
            const todayDate = new Date(todayISO);

            let unfinishedTasks = [];

            // Scan all storge
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('diary_')) {
                    const dateStr = key.replace('diary_', '');
                    const itemDate = new Date(dateStr);

                    // Specific check: Date is STRICTLY BEFORE today
                    if (itemDate < todayDate) {
                        const items = getTodoItems(dateStr);
                        const panding = items.filter(t => !t.done);
                        if (panding.length > 0) {
                            unfinishedTasks.push({ date: dateStr, count: panding.length, tasks: panding });
                        }
                    }
                }
            }

            if (unfinishedTasks.length > 0) {
                let msg = '';
                unfinishedTasks.sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first

                unfinishedTasks.forEach(g => {
                    msg += `üìÖ ${g.date} Êúâ ${g.count} ‰ª∂Êú™ÂÆåÊàê:\n`;
                    g.tasks.forEach(t => {
                        msg += `  - ${t.text.substring(0, 15)}${t.text.length > 15 ? '...' : ''}\n`;
                    });
                    msg += '\n';
                });

                elements.reminderText.innerText = msg;
                elements.reminderOverlay.classList.add('active');
            }
        }

        function closeReminder() {
            elements.reminderOverlay.classList.remove('active');
        }

        function exportData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith('diary_')) data[k] = localStorage.getItem(k);
            }
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `diary_backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            toggleMenu();
        }

        function importData(input) {
            const f = input.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    Object.keys(d).forEach(k => {
                        if (k.startsWith('diary_')) localStorage.setItem(k, d[k]);
                    });
                    alert('ÂåØÂÖ•ÊàêÂäüÔºÅ');
                    renderCalendar();
                    toggleMenu();
                } catch (zh) { alert('Ê™îÊ°àÈåØË™§'); }
            };
            r.readAsText(f);
            toggleMenu();
        }
    </script>
</body>

</html>